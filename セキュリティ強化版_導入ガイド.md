# kintone_base64_viewer セキュリティ強化版 導入ガイド

## 📋 概要

このドキュメントは、セキュリティを大幅に強化した `kintone_base64_viewer v3.0` の導入手順とアップグレード方法を説明します。

## ⚠️ 重要：既存バージョンからの主な変更点

### セキュリティ改善項目
- ✅ **Base64検証の強化**: 5層の検証システム
- ✅ **サイズ制限の厳格化**: 350KB → 75KB
- ✅ **レート制限**: ユーザー単位で1分間に10回まで
- ✅ **同時処理数制限**: 最大3つまで
- ✅ **タイムアウト設定**: 5秒で処理中断
- ✅ **CSP互換性チェック**: セキュリティポリシー対応
- ✅ **メモリリーク対策**: 適切なリソース管理
- ✅ **エラーハンドリング強化**: 情報漏洩防止

## 🚀 導入手順

### STEP 1: 前準備
1. **バックアップの取得**
   ```
   現在使用中のJavaScriptファイルをダウンロードして保存
   ```

2. **アプリ設定の確認**
   - フィールドコード: `base64viewer` (デフォルト)
   - スペース要素ID: `SP_Viewer` (デフォルト)

### STEP 2: ファイルの配置
1. `kintone_base64_viewer_secure.js` をkintoneアプリにアップロード
2. 既存のJavaScriptファイルは削除または無効化

### STEP 3: 設定の確認と調整

#### 基本設定（CONFIG部分の調整）
```javascript
const CONFIG = {
  fieldCode: 'base64viewer',              // ← 必要に応じて変更
  spaceElement: 'SP_Viewer',              // ← 必要に応じて変更
  maxBase64Size: 100000,                  // 約75KB
  maxConcurrentValidations: 3,            // 同時処理数
  imageValidationTimeout: 5000,           // 5秒タイムアウト
  rateLimit: {
    windowMs: 60000,                      // 1分
    maxRequests: 10                       // 10回まで
  }
};
```

### STEP 4: 動作確認
1. **正常ケースのテスト**
   - 小さなBase64画像データで表示確認
   - モーダル表示の動作確認

2. **セキュリティ機能のテスト**
   - 大容量データでサイズ制限の確認
   - 無効なBase64データでエラーハンドリング確認

## 🔧 設定のカスタマイズ

### サイズ制限の調整
```javascript
// より厳格にする場合（50KB以下）
maxBase64Size: 66666,  // 約50KB

// 少し緩くする場合（100KB以下）
maxBase64Size: 133333,  // 約100KB
```

### レート制限の調整
```javascript
// より厳格にする場合
rateLimit: {
  windowMs: 60000,    // 1分
  maxRequests: 5      // 5回まで
}

// 緩くする場合
rateLimit: {
  windowMs: 60000,    // 1分
  maxRequests: 20     // 20回まで
}
```

### 同時処理数の調整
```javascript
// より制限する場合
maxConcurrentValidations: 2,

// 少し緩くする場合
maxConcurrentValidations: 5,
```

## 📊 新機能の詳細説明

### 1. 5層Base64検証システム
```javascript
// 実装される検証内容
✓ 文字列タイプと長さチェック
✓ Base64文字セット検証
✓ 構造チェック（4の倍数）
✓ パディング位置検証
✓ デコード/エンコード整合性確認
```

### 2. レート制限機能
```javascript
// ユーザー単位での制限
- 1分間に10回までの処理制限
- ユーザーIDベースの追跡
- 制限超過時の適切なエラー表示
```

### 3. リソース管理強化
```javascript
// メモリリーク対策
- Imageオブジェクトの適切なクリーンアップ
- タイムアウト処理による強制終了
- 同時処理数の制御
```

## 🔍 ログとモニタリング

### セキュリティログの確認
ブラウザの開発者ツール（F12）のConsoleで以下のログを確認できます：

```javascript
// 正常処理時
[Base64Viewer Security] IMAGE_DISPLAYED: {size: 12345, timestamp: "2024-XX-XX..."}

// エラー発生時
[Base64Viewer Security] SECURITY_ERROR: {error: "SIZE_LIMIT_EXCEEDED", ...}
```

### モニタリング項目
- ファイルサイズ制限違反の頻度
- レート制限到達の頻度
- CSPエラーの発生状況
- 無効なBase64データの検出数

## ⚠️ トラブルシューティング

### よくある問題と解決方法

#### 1. 「セキュリティ設定により画像を表示できません」
**原因**: CSP設定が厳格
**解決法**: 
```http
Content-Security-Policy に img-src 'self' data: が含まれているか確認
```

#### 2. 「ファイルサイズが上限を超えています」
**原因**: 新しいサイズ制限（75KB）に抵触
**解決法**: 
- 画像を圧縮する
- 設定でmaxBase64Sizeを調整する

#### 3. 「リクエスト制限に達しました」
**原因**: 1分間に10回以上の処理実行
**解決法**: 
- 1分待ってから再実行
- 設定でrateLimit.maxRequestsを調整する

#### 4. 「同時処理数の上限に達しています」
**原因**: 3つ以上の画像を同時処理
**解決法**: 
- 少し待ってから再実行
- 設定でmaxConcurrentValidationsを調整する

### デバッグ方法
1. **ブラウザのConsoleを確認**
   ```javascript
   // エラーの詳細を確認
   F12 → Console → エラーメッセージをチェック
   ```

2. **設定の確認**
   ```javascript
   // 読み込み時に表示される設定情報を確認
   kintone_base64_viewer (Security Enhanced v3.0) が読み込まれました
   設定: {fieldCode: "base64viewer", maxSize: "100000文字 (約75KB)", ...}
   ```

## 📈 パフォーマンス比較

### v2.0 → v3.0 セキュリティ改善

| 項目 | v2.0 | v3.0 (強化版) |
|------|------|---------------|
| Base64検証 | 1層（正規表現のみ） | 5層（包括的検証） |
| サイズ制限 | 350KB | 75KB |
| 同時処理制限 | なし | 3つまで |
| タイムアウト | なし | 5秒 |
| レート制限 | なし | 10回/分 |
| メモリ管理 | 基本的 | 強化済み |
| CSP対応 | なし | 対応済み |

### 推奨する段階的導入

#### フェーズ1: 基本導入（1週間）
- セキュリティ強化版の導入
- 基本動作の確認
- ユーザーへの周知

#### フェーズ2: 監視期間（2週間）
- ログの監視
- パフォーマンスの確認
- 必要に応じた設定調整

#### フェーズ3: 最適化（1週間）
- 使用状況に応じた設定の微調整
- ユーザーフィードバックの反映

## 📞 サポート情報

### 設定変更が必要な場合
```javascript
// CONFIG オブジェクトの値を環境に合わせて調整してください
// 変更後は必ずテストを実施してください
```

### 今後の更新予定
- セキュリティログのkintoneアプリ連携機能
- より詳細な統計情報の提供
- 管理者向けダッシュボード機能

このセキュリティ強化版により、より安全で信頼性の高いBase64画像表示機能を提供できます。