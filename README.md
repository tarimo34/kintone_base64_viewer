# kintone_base64_viewer
Base64形式でエンコードされた画像データの文字列から画像に表示するものです。レコード詳細画面に画像を表示します。

## 機能
- 指定したフィールドからBase64エンコードされた画像データ(文字列)を取得
- 画像データの有効性を検証
- 有効な画像データの場合、指定されたスペースフィールドに表示
- 画像をクリックすると拡大表示するモーダルウィンドウ機能

## 使用方法

### 準備
1. kintoneアプリに「Base64Viewer」という名前のフィールド（テキストエリアなど）を作成します
2. レコード詳細画面に「SP_Viewer」という名前のスペースフィールドを配置します

### 設定
- デフォルトでは、フィールドコードは`base64viewer`に設定されています
- 必要に応じて、スクリプト内の`fieldCode`変数の値を変更してください

```javascript
const fieldCode = 'base64viewer'; // フィールドコードを変更してください
```

## 動作の説明

1. レコード詳細画面の表示時に自動的に実行されます
2. 指定されたフィールドからBase64エンコードされたデータを取得します
3. データが存在しない場合は「画像データがありません」というメッセージを表示します
4. データの形式が正しいBase64形式かチェックします
5. データのサイズが上限（約350KB）を超えていないかチェックします
6. データが存在する場合、そのデータが有効な画像かどうかを検証します
7. 無効な画像データの場合は「画像データとして無効です」というメッセージを表示します
8. 有効な画像データの場合、画像を表示します（最大幅300px）
9. 画像をクリックすると拡大表示するモーダルウィンドウが開きます
10. モーダルウィンドウ内の任意の場所をクリックすると閉じます

## セキュリティ対策

### XSS（クロスサイトスクリプティング）対策
- `innerHTML`の使用を最小限に抑え、代わりに`textContent`と`createElement`+`appendChild`を使用しています
- これにより、悪意のあるスクリプトが実行されるリスクを低減しています

### Base64データの妥当性チェック
- 正規表現を使用して、文字列がBase64形式に準拠しているかを事前に検証しています
- Base64で使用される文字のみ（A-Z, a-z, 0-9, +, /, =）を許可しています

### DoS（Denial-of-Service）対策
- 大きなBase64文字列によるブラウザの負荷を防ぐため、データサイズに上限（500,000文字、約350KB）を設けています
- サイズ制限を超えるデータは処理されず、エラーメッセージが表示されます

### MIMEタイプの柔軟性
- データ文字列が既に`data:`で始まる場合はそのまま使用し、そうでない場合は`data:image/png;base64,`プレフィックスを追加します
- これにより、様々な形式の画像データを処理できます

### DOM要素の名前空間
- モーダルや画像要素に専用のクラス名（`antbear-base64-modal`, `antbear-base64-thumb`など）を設定しています
- これにより、他のCSSやJavaScriptとの競合を避けることができます

## 技術的な説明

### validateBase64Image関数
この関数は、Base64エンコードされた文字列が有効な画像かどうかを検証します。

```javascript
function validateBase64Image(base64, callback) {
  const img = new Image();
  img.onload = function () { callback(true); };
  img.onerror = function () { callback(false); };
  img.src = base64.startsWith('data:')
    ? base64
    : 'data:image/png;base64,' + base64;
}
```

### isBase64Format関数
この関数は、文字列が正しいBase64形式かどうかを検証します。

```javascript
function isBase64Format(str) {
  return /^[A-Za-z0-9+/=]+$/.test(str);
}
```

- 新しいImageオブジェクトを作成
- 画像が正常に読み込まれた場合はコールバック関数にtrueを渡す
- 画像の読み込みに失敗した場合はコールバック関数にfalseを渡す

## バージョン履歴

### Version 1.0 (初版)
- Base64エンコードされた画像データを表示する基本機能を実装
- モーダルウィンドウでの画像拡大表示機能
- 画像データの簡易検証機能

### Version 2.0 (セキュリティ強化版)
以下のセキュリティ対応の改善：

1. **XSS対策の強化**
   - `innerHTML`の使用を最小限に抑え、`textContent`と`createElement`+`appendChild`に置き換え
   - 文字列連結ではなくDOM操作を使用することで、悪意のあるスクリプト注入のリスクを低減

2. **Base64データの厳格な検証**
   - 正規表現による文字レベルの検証機能を追加
   - Base64で使用される文字のみを許可するフィルタリング実装

3. **DoS（Denial-of-Service）対策**
   - 大きなBase64データによるブラウザの負荷を防止するためのサイズ制限（約350KB）を実装
   - 上限を超えるデータに対するエラー処理と通知機能

4. **柔軟なMIMEタイプ対応**
   - データが既に`data:`プレフィックスを持つ場合は、そのままのMIMEタイプを使用
   - より多様な画像形式に対応可能に改善

5. **DOM要素の名前空間管理**
   - 専用クラス名（`kintonecafenara-base64-modal`, `kintonecafenara-base64-thumb`など）の導入
   - 他のCSSやJavaScriptとの競合を防止する設計 
